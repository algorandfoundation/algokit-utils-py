name: Check Python Code

on:
  workflow_call:

jobs:
  check-python:
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync

      - name: Audit with pip-audit
        run: |
          # GHSA-4xh5-x5gv-qwph is safe to ignore since we are using a python version that is not affected
          #                     can remove once pip has fix
          # Audit all installed dependencies with exclusions
          # If a vulnerability is found in a dev dependency without an available fix,
          # it can be temporarily ignored by adding --ignore-vuln e.g.
          # --ignore-vuln "GHSA-hcpj-qp55-gfph" # GitPython vulnerability, dev only dependency
          uv run pip-audit --ignore-vuln GHSA-4xh5-x5gv-qwph

      - name: Check codebase with ruff and mypy
        run: |
          # stop the build if there are files that don't meet formatting requirements
          uv run poe lint

      - name: Setup Polytest
        uses: aorumbayev/algokit-polytest/.github/actions/setup-polytest@main

      - name: Validate polytest algod_client tests
        run: uv run poe polytest-validate-algod

      - name: Validate polytest indexer_client tests
        run: uv run poe polytest-validate-indexer

      - name: Validate polytest kmd_client tests
        run: uv run poe polytest-validate-kmd
