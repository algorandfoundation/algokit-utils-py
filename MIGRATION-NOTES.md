# Migration Notes

A collection of notes to consolidate todos during decoupling efforts (similar doc exists on ts version as well).

## API

### Generator

- Currently generated models for KMD have explicit request models resulting in slightly different signatures in contrast with indexer and algod and requiring imports of explicit typed request models specifically on kmd client calls. Do we want to further refine the generation to auto flatten the keys to ensure it does not define an explicit request models or change those models to TypedDicts to reduce the import overhead?

### Algod OAS

- is_frozen field on models in algod is a boolean in the spec but actual returning value is an integer, serde must be updated to handle casting to bool.

### KMD

- algokit-core repo on a branch called feat/account-manager, we had a minor refinement in OAS spec for kmd adding a default value for wallet driver field as well as the generator adjustments to ensure generated model for related endpoint falls back to default 'sqlite' value. Do we want to restore this approach?:

### Type annotations

- Type hints and documentation now refer to the generated `algokit_algod_client.AlgodClient` (instead of `algosdk.v2client.algod.AlgodClient`). Update any downstream annotations or typing imports accordingly when migrating to v4.

## ABI

- decoding `byte`, `byte[]` and `byte[n]` now results in a python `bytes` type instead of `list[int]`
- encoding `byte` now accepts `bytes` or `int` types
- decoding `ufixed` types now returns a `decimal.Decimal` instead of an `int`
- encoding `ufixed` types now accepts a `decimal.Decimal` or an `int`
- tuple types decode to `tuple` instead of `list`
- Clarify on whether we are ok with dropping arc32 contracts from type unions in app spec params in app factory and app client

### ABI return naming

- Decide on naming for `ABIReturn` fields (e.g. `value` vs `return_value`, `raw_value` vs `raw_return_value`).
- Current branch aligns with the Rust approach where SDK and ABI variants of `ABIReturn` are merged into one abstraction; do we keep the same approach in the TS equivalent?

## AlgoSDK primitives

- What do we do with SourceMap abstraction? AlgoSDK version is more feature complete, while we also have a simple autogenerated sourcemap variant in algosdk. ts currently relies on ProgramSourceMap which is vendored from js algosdk. Do we drop the vendored variants completely and enhance api generator to hand roll a custom sourcemap variant we need and rely on that everywhere? Or do we move the vendored source map variant into the algokit-utils and enhance it there?

- BoxReference used to be a subclass of algosdk BoxReference, now there is a direct equivalent imported from transact package. Do we want to keep aliasing the BoxReference to transact version or do we want to deprecate and advice consumers to import directly from transact?

## Block Model Restructuring (TS Alignment)

### Breaking Changes

- `GetBlock` removed → use `BlockResponse`
- `BlockHeader` fields reorganized into nested types:
  - `header.fee_sink` → `header.reward_state.fee_sink`
  - `header.rewards_pool` → `header.reward_state.rewards_pool`
  - `header.rewards_level` → `header.reward_state.rewards_level`
  - `header.rewards_rate` → `header.reward_state.rewards_rate`
  - `header.rewards_residue` → `header.reward_state.rewards_residue`
  - `header.rewards_recalculation_round` → `header.reward_state.rewards_recalculation_round`
  - `header.current_protocol` → `header.upgrade_state.current_protocol`
  - `header.next_protocol` → `header.upgrade_state.next_protocol`
  - `header.next_protocol_approvals` → `header.upgrade_state.next_protocol_approvals`
  - `header.next_protocol_vote_before` → `header.upgrade_state.next_protocol_vote_before`
  - `header.next_protocol_switch_on` → `header.upgrade_state.next_protocol_switch_on`
  - `header.upgrade_propose` → `header.upgrade_vote.upgrade_propose`
  - `header.upgrade_delay` → `header.upgrade_vote.upgrade_delay`
  - `header.upgrade_approve` → `header.upgrade_vote.upgrade_approve`
  - `header.transactions_root` → `header.txn_commitments.transactions_root`
  - `header.transactions_root_sha256` → `header.txn_commitments.transactions_root_sha256`
- `BlockEvalDelta.bytes` → `BlockEvalDelta.bytes_value` (avoid Python keyword)
- `BlockAppEvalDelta.inner_txns` type changed: `SignedTxnInBlock` → `SignedTxnWithAD`
- `previous_block_hash` and `genesis_hash` now non-optional with `bytes(32)` defaults

### Migration

```python
# Before
from algokit_algod_client.models import GetBlock
response: GetBlock = algod_client.get_block(...)
fee_sink = response.block.header.fee_sink
protocol = response.block.header.current_protocol
proposal = response.block.header.upgrade_propose

# After
from algokit_algod_client.models import BlockResponse
response: BlockResponse = algod_client.get_block(...)
fee_sink = response.block.header.reward_state.fee_sink
protocol = response.block.header.upgrade_state.current_protocol
proposal = response.block.header.upgrade_vote.upgrade_propose
```

## Fixed-Length Byte Validation

### Breaking Changes

- Runtime validation for fixed-length byte fields (32/64 bytes)
- `ValueError` raised if byte length doesn't match expected length
- Affects: `group`, `lease`, signatures, hashes, keys, commitment roots

### Migration

```python
# Validation now enforced at encode/decode
# 32-byte fields: group, lease, transaction hashes, block hashes, keys
# 64-byte fields: signatures, SHA-512 hashes

# Before: silently accepted wrong lengths
txn.group = bytes(10)  # No error

# After: raises ValueError
txn.group = bytes(10)  # ValueError: Expected 32 bytes, got 10
txn.group = bytes(32)  # OK
```

## Account and Signer Type Renames (TS Alignment)

### Breaking Changes

| Before | After | Notes |
|--------|-------|-------|
| `SigningAccount` | `AddressWithSigners` | Class renamed; `.address` → `.addr` |
| `TransactionSignerAccountProtocol` | `AddressWithTransactionSigner` | Protocol renamed; `.address` → `.addr` |
| `SignerAccountProtocol` | `AddressWithSigners` | Protocol merged into concrete class |
| `LsigSigner` | `DelegatedLsigSigner` | Type alias renamed |
| `AddressWithLsigSigner` | `AddressWithDelegatedLsigSigner` | Protocol renamed |

### Justification

- Aligns with `algokit-utils-ts` naming conventions
- Python uses `AddressWithTransactionSigner` despite having no `Address` type (unlike TS) for cross-SDK consistency
- The `addr` property matches TypeScript's `TransactionSignerAccount.addr`

### Migration

```python
# Before
from algokit_utils import SigningAccount, TransactionSignerAccountProtocol
account = SigningAccount(...)
print(account.address)

# After
from algokit_utils.transact import AddressWithSigners, AddressWithTransactionSigner
account = AddressWithSigners(...)
print(account.addr)
```

## MultisigAccount and LogicSigAccount Relocation (TS Alignment)

### Breaking Changes

| Before | After | Notes |
|--------|-------|-------|
| `algokit_utils.models.account.MultisigAccount` | `algokit_transact.MultisigAccount` | Moved to transact package |
| `algokit_utils.models.account.MultisigMetadata` | `algokit_transact.MultisigMetadata` | Moved to transact package; `.addresses` → `.addrs` |
| `algokit_utils.models.account.LogicSigAccount` | `algokit_transact.LogicSigAccount` | Moved to transact package |

### Justification

- Aligns with `algokit-utils-ts` PR #465 which moved these classes to `@algorandfoundation/algokit-transact`
- `MultisigMetadata.addrs` matches TypeScript's `MultisigMetadata.addrs` property

### Backward Compatibility

Classes remain importable from original locations via re-exports:
- `algokit_utils.models.account` (re-exports from transact)
- `algokit_utils.transact` (re-exports from transact)

### Migration

```python
# Before
from algokit_utils.models.account import MultisigAccount, MultisigMetadata, LogicSigAccount
metadata = MultisigMetadata(version=1, threshold=2, addresses=["addr1", "addr2"])

# After (preferred)
from algokit_transact import MultisigAccount, MultisigMetadata, LogicSigAccount
metadata = MultisigMetadata(version=1, threshold=2, addrs=["addr1", "addr2"])

# Or via algokit_utils.transact
from algokit_utils.transact import MultisigAccount, MultisigMetadata, LogicSigAccount
```

## Contributing Guide

- Introduce comprehensive contributing guide around running tests/updating snapshots in API client tests and dealing with Polytest

## Polytest Integration

Tracks polytest-generated API endpoint test coverage and **parity with `algokit-utils-ts`**.

> Both Python and TypeScript use the same OAS spec (`fix/more-tweaks` from `algorandfoundation/algokit-oas-generator`) and skip the same endpoints (`private`, `experimental`, `Metrics`, `SwaggerJSON`, `GetBlockLogs`). The TS polytest config includes 13 extra endpoints that don't exist in either generated client.

### Coverage Summary (Python vs TypeScript)

| Client | Py Stubs | Py Impl | TS Stubs | TS Impl | Notes |
|--------|----------|---------|----------|---------|-------|
| Algod | 42 | 21 (50%) | 55 | 17 (31%) | TS has 13 orphan stubs for skipped endpoints |
| Indexer | 21 | 21 (100%) | 0 | 0 | TS has no indexer polytest config |
| KMD | 23 | 1 (4%) | 0 | 0 | TS has no KMD polytest config |

### Algod Endpoint Coverage

| Endpoint | Py | TS | Notes |
|----------|:--:|:--:|-------|
| `GET genesis` | ✅ | ✅ | |
| `GET health` | ✅ | ✅ | |
| `GET ready` | ✅ | ✅ | |
| `GET versions` | ✅ | ✅ | |
| `GET v2/accounts/{address}` | ✅ | ✅ | |
| `GET v2/accounts/{address}/applications/{app-id}` | ✅ | ✅ | |
| `GET v2/accounts/{address}/assets/{asset-id}` | ✅ | ✅ | |
| `GET v2/accounts/{address}/transactions/pending` | ✅ | ⬜ | |
| `GET v2/applications/{app-id}` | ✅ | ✅ | |
| `GET v2/applications/{app-id}/box` | ⬜ | ⬜ | |
| `GET v2/applications/{app-id}/boxes` | ⬜ | ⬜ | |
| `GET v2/assets/{asset-id}` | ✅ | ✅ | |
| `GET v2/blocks/{round}` | ✅ | ⬜ | |
| `GET v2/blocks/{round}/hash` | ✅ | ✅ | |
| `GET v2/blocks/{round}/lightheader/proof` | ✅ | ✅ | |
| `GET v2/blocks/{round}/transactions/{txid}/proof` | ⬜ | ⬜ | |
| `GET v2/blocks/{round}/txids` | ✅ | ✅ | |
| `GET v2/deltas/{round}` | ✅ | ⬜ | |
| `GET v2/deltas/{round}/txn/group` | ⬜ | ⬜ | |
| `GET v2/deltas/txn/group/{id}` | ⬜ | ⬜ | |
| `GET v2/devmode/blocks/offset` | ⬜ | ⬜ | Dev mode |
| `GET v2/experimental` | ⬜ | ⬜ | |
| `GET v2/ledger/supply` | ✅ | ✅ | |
| `GET v2/ledger/sync` | ✅ | ✅ | |
| `GET v2/stateproofs/{round}` | ⬜ | ⬜ | |
| `GET v2/status` | ✅ | ✅ | |
| `GET v2/status/wait-for-block-after/{round}` | ✅ | ✅ | |
| `GET v2/transactions/params` | ✅ | ✅ | |
| `GET v2/transactions/pending` | ✅ | ⬜ | |
| `GET v2/transactions/pending/{txid}` | ⬜ | ⬜ | |
| `DELETE v2/catchup/{catchpoint}` | ⬜ | ⬜ | Admin |
| `DELETE v2/ledger/sync` | ⬜ | ⬜ | Admin |
| `POST v2/catchup/{catchpoint}` | ⬜ | ⬜ | Admin |
| `POST v2/devmode/blocks/offset/{offset}` | ⬜ | ⬜ | Dev mode |
| `POST v2/ledger/sync/{round}` | ⬜ | ⬜ | Admin |
| `POST v2/shutdown` | ⬜ | ⬜ | Admin |
| `POST v2/teal/compile` | ⬜ | ⬜ | |
| `POST v2/teal/disassemble` | ⬜ | ⬜ | |
| `POST v2/teal/dryrun` | ⬜ | ⬜ | |
| `POST v2/transactions` | ⬜ | ⬜ | |
| `POST v2/transactions/async` | ⬜ | ⬜ | |
| `POST v2/transactions/simulate` | ⬜ | ⬜ | |

**TS-only stubs (no client method):** `GET debug/settings/*`, `GET metrics`, `GET swagger.json`, `GET v2/accounts/{addr}/assets`, `GET v2/blocks/{round}/logs`, `*v2/participation/*`

### Indexer Endpoint Coverage (Python only)

| Endpoint | Py |
|----------|:--:|
| `GET health` | ✅ |
| `GET v2/accounts` | ✅ |
| `GET v2/accounts/{id}` | ✅ |
| `GET v2/accounts/{id}/apps-local-state` | ✅ |
| `GET v2/accounts/{id}/assets` | ✅ |
| `GET v2/accounts/{id}/created-applications` | ✅ |
| `GET v2/accounts/{id}/created-assets` | ✅ |
| `GET v2/accounts/{id}/transactions` | ✅ |
| `GET v2/applications` | ✅ |
| `GET v2/applications/{id}` | ✅ |
| `GET v2/applications/{id}/box` | ✅ |
| `GET v2/applications/{id}/boxes` | ✅ |
| `GET v2/applications/{id}/logs` | ✅ |
| `GET v2/assets` | ✅ |
| `GET v2/assets/{id}` | ✅ |
| `GET v2/assets/{id}/balances` | ✅ |
| `GET v2/assets/{id}/transactions` | ✅ |
| `GET v2/block-headers` | ✅ |
| `GET v2/blocks/{round}` | ✅ |
| `GET v2/transactions` | ✅ |
| `GET v2/transactions/{txid}` | ✅ |

### KMD Endpoint Coverage (Python only)

| Endpoint | Py |
|----------|:--:|
| `GET v1/wallets` | ✅ |
| `GET versions` | ⬜ |
| `GET swagger.json` | ⬜ |
| `DELETE v1/key` | ⬜ |
| `DELETE v1/multisig` | ⬜ |
| `POST v1/key` | ⬜ |
| `POST v1/key/export` | ⬜ |
| `POST v1/key/import` | ⬜ |
| `POST v1/key/list` | ⬜ |
| `POST v1/master-key/export` | ⬜ |
| `POST v1/multisig/*` (5 endpoints) | ⬜ |
| `POST v1/program/sign` | ⬜ |
| `POST v1/transaction/sign` | ⬜ |
| `POST v1/wallet` | ⬜ |
| `POST v1/wallet/info` | ⬜ |
| `POST v1/wallet/init` | ⬜ |
| `POST v1/wallet/release` | ⬜ |
| `POST v1/wallet/rename` | ⬜ |
| `POST v1/wallet/renew` | ⬜ |

### Manual Tests

| Client | Test | Description |
|--------|------|-------------|
| Algod | `manual/test_block.py` | Block endpoint against mainnet/testnet |
| Algod | `manual/test_ledger_state_delta.py` | Ledger state delta |
| Algod | `manual/test_pending_transaction_information.py` | Pending tx info on localnet |
| Algod | `manual/test_raw_transaction.py` | Raw tx broadcast on localnet |
| Algod | `manual/test_simulate_transactions.py` | Tx simulation with trace config |
| Algod | `manual/test_suggested_params.py` | Suggested params and error handling |
| Indexer | `manual/test_search_applications.py` | Search applications |
| Indexer | `manual/test_search_transactions.py` | Search/lookup transactions |
| KMD | `manual/test_wallet_lifecycle.py` | Wallet creation and listing |
| KMD | `manual/test_key_management.py` | Key generation and wallet handles |

### Test Infrastructure

- **Mock Server**: `ghcr.io/aorumbayev/polytest-mock-server:latest` (ports 18000-18002)
- **Parallel Execution**: `filelock` for xdist worker coordination
- **Config**: `tests/modules/conftest.py`
